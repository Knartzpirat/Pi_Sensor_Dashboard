generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  username  String   @unique
  password  String
  role      String   @default("admin")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationen
  refreshTokens   RefreshToken[]
  recoveryCodes RecoveryCode[]

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  
  // "Angemeldet bleiben" Flag
  persistent Boolean  @default(false)
  
  // Security
  ipAddress String?
  userAgent String?
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model RecoveryCode {
  id        String    @id @default(cuid())
  code      String    // Gehasht gespeichert (bcrypt)
  used      Boolean   @default(false)
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  
  // Beziehung zum User
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([used])
  @@map("recovery_codes")
}


model SetupStatus {
  id          String   @id @default(cuid())
  isCompleted Boolean  @default(false)
  completedAt DateTime?
  version     String?

  @@map("setup_status")
}

// Label-Tabelle (wiederverwendbare Tags/Kategorien)
// Label-Tabelle mit Type für verschiedene Kategorien
model Label {
  id        String       @id @default(cuid())
  name      String
  color     String?      // z.B. "#FF5733"
  type      EntityType     
  createdAt DateTime     @default(now())
  
  testObjects TestObject[]
  
  @@unique([name, type])  // ← Name muss nur pro Typ unique sein
  @@index([type])
}

// Enum für Label-Typen
enum EntityType {
  TEST_OBJECT
  SENSOR
  USER_PROFILE
  MEASUREMENT
  // ... weitere Typen später
}

// Testobjekt-Tabelle
model TestObject {
  id          String    @id @default(cuid())
  title       String
  description String?   @db.Text
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  labelId     String?
  label       Label?    @relation(fields: [labelId], references: [id], onDelete: SetNull)
  
  @@index([labelId])
  @@index([createdAt])
}

// Bilder-Tabelle mit Reihenfolge
model Picture {
  id            String     @id @default(cuid())
  filename      String
  originalName  String
  mimeType      String
  size          Int
  url           String
  order         Int        @default(0)

  // Polymorphe Beziehung
  entityType    EntityType           // ← Zu welcher Entität gehört das Bild?
  entityId      String               // ← ID der Entität

  createdAt     DateTime   @default(now())

  @@index([entityType, entityId, order])
  @@index([entityType, entityId])
}

// PDF/Dokument-Tabelle mit Reihenfolge
model Document {
  id            String     @id @default(cuid())
  filename      String
  originalName  String
  mimeType      String     // z.B. "application/pdf"
  size          Int
  url           String
  order         Int        @default(0)

  // Polymorphe Beziehung
  entityType    EntityType           // ← Zu welcher Entität gehört das Dokument?
  entityId      String               // ← ID der Entität

  createdAt     DateTime   @default(now())

  @@index([entityType, entityId, order])
  @@index([entityType, entityId])
}
